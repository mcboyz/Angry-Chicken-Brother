<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Flappy Bird Mobile (with Audio)</title>
<style>
  body { margin:0; background:#70c5ce; overflow:hidden; }
  canvas { display:block; margin:0 auto; background:#70c5ce; }
  #hint { position: absolute; left: 50%; transform: translateX(-50%); top: 8px; color: white; font-family: sans-serif; font-size: 14px; }
</style>
</head>
<body>
<div id="hint">Tap / Click to flap. BG music will start on first tap (mobile browsers require interaction).</div>
<canvas id="game"></canvas>

<!-- Audio elements (preloaded). We will start bgm on first user interaction. -->
<audio id="bgm" src="bgm.wav" loop preload="auto"></audio>
<audio id="flap1" src="jump.wav" preload="auto"></audio>
<audio id="flap2" src="jump.wav" preload="auto"></audio>
<audio id="point1" src="jump.wav" preload="auto"></audio>
<audio id="point2" src="jump.wav" preload="auto"></audio>
<audio id="hit1" src="hit.wav" preload="auto"></audio>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
resize();
window.addEventListener('resize', resize);

let bgm = document.getElementById('bgm');
const flapSounds = [document.getElementById('flap1'), document.getElementById('flap2')];
let flapIndex = 0;
const pointSounds = [document.getElementById('point1'), document.getElementById('point2')];
let pointIndex = 0;
const hitSound = document.getElementById('hit1');

let startedAudio = false;
function ensureAudioStarted() {
  if (!startedAudio) {
    // Play and immediately pause bgm to unlock on some browsers, then play when ready
    bgm.volume = 0.6;
    bgm.play().catch(()=>{});
    startedAudio = true;
  }
}

let frames = 0, speed = 2, score = 0, bestScore = 0, gameOver = false;
const sprite = {};

// Simple placeholders for images (we use colored rectangles if no images)
function loadImage(name, src) {
  return new Promise((resolve) => {
    let img = new Image();
    img.onload = () => resolve({name, img});
    img.onerror = () => resolve({name, img: null});
    img.src = src;
  });
}

async function loadAssets() {
  const assets = await Promise.all([
    loadImage('bg', 'background.png'),
    loadImage('bird', 'jige.png'),
    loadImage('pipeTop', 'pipe-top.png'),
    loadImage('pipeBottom', 'pipe-bottom.png'),
    loadImage('ground', 'ground.png')
  ]);
  assets.forEach(a => sprite[a.name] = a.img);
  startGame();
}

const bird = {
  x: 80, y: 150, w: 34, h: 24, gravity: 0.25, jump: 4.6, speed: 0, rotation: 0,
  draw() {
    ctx.save();
    ctx.translate(this.x, this.y);
    ctx.rotate(this.rotation);
    if (sprite.bird) ctx.drawImage(sprite.bird, -this.w/2, -this.h/2, this.w, this.h);
    else { ctx.fillStyle='yellow'; ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h); }
    ctx.restore();
  },
  flap() { this.speed = -this.jump; },
  update() {
    this.speed += this.gravity; this.y += this.speed;
    const groundH = sprite.ground ? sprite.ground.height : 80;
    if (this.y + this.h/2 >= canvas.height - groundH) { this.y = canvas.height - groundH - this.h/2; gameOver = true; playHit(); }
    this.rotation = (this.speed >= this.jump) ? 90 * Math.PI/180 : -25 * Math.PI/180;
  },
  reset() { this.y = 150; this.speed = 0; this.rotation = 0; }
};

const pipes = { position: [], w: 52, h: 320, gap: 150, maxYPos: -150,
  draw() {
    for (let p of this.position) {
      if (sprite.pipeTop) ctx.drawImage(sprite.pipeTop, p.x, p.y, this.w, this.h);
      else { ctx.fillStyle='green'; ctx.fillRect(p.x, p.y, this.w, this.h); }
      if (sprite.pipeBottom) ctx.drawImage(sprite.pipeBottom, p.x, p.y + this.h + this.gap, this.w, this.h);
      else { ctx.fillStyle='darkgreen'; ctx.fillRect(p.x, p.y + this.h + this.gap, this.w, this.h); }
    }
  },
  update() {
    if (frames % 100 === 0) this.position.push({ x: canvas.width, y: this.maxYPos * (Math.random() + 1) });
    for (let i = 0; i < this.position.length; i++) {
      let p = this.position[i]; p.x -= speed;
      // collision
      if (bird.x + bird.w/2 > p.x && bird.x - bird.w/2 < p.x + this.w) {
        if (bird.y - bird.h/2 < p.y + this.h || bird.y + bird.h/2 > p.y + this.h + this.gap) { gameOver = true; playHit(); }
      }
      // scoring
      if (!p.scored && p.x + this.w < bird.x) { score++; p.scored = true; speed += 0.05; playPoint(); }
      if (p.x + this.w <= 0) { this.position.shift(); i--; }
    }
  },
  reset() { this.position = []; }
};

const ground = { draw() { if (sprite.ground) ctx.drawImage(sprite.ground, 0, canvas.height - sprite.ground.height, canvas.width, sprite.ground.height); else { ctx.fillStyle='#deb887'; ctx.fillRect(0, canvas.height - 80, canvas.width, 80); } } };

function drawBackground() { if (sprite.bg) ctx.drawImage(sprite.bg, 0, 0, canvas.width, canvas.height); else { ctx.fillStyle='#70c5ce'; ctx.fillRect(0,0,canvas.width,canvas.height); } }

function drawScore() { ctx.fillStyle='#fff'; ctx.strokeStyle='#000'; ctx.lineWidth=2; ctx.font='bold 36px Arial'; ctx.textAlign='center'; ctx.fillText(score, canvas.width/2, 60); ctx.strokeText(score, canvas.width/2, 60); }

function playFlap() { ensureAudioStarted(); flapSounds[flapIndex].currentTime = 0; flapSounds[flapIndex].play().catch(()=>{}); flapIndex = (flapIndex+1)%flapSounds.length; }
function playPoint() { ensureAudioStarted(); pointSounds[pointIndex].currentTime = 0; pointSounds[pointIndex].play().catch(()=>{}); pointIndex = (pointIndex+1)%pointSounds.length; }
function playHit() { ensureAudioStarted(); hitSound.currentTime = 0; hitSound.play().catch(()=>{}); bgm.pause(); }

function startGame() {
  frames = 0; function draw() { drawBackground(); pipes.draw(); ground.draw(); bird.draw(); drawScore(); }
  function update() { bird.update(); pipes.update(); }
  function loop() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    draw();
    if (!gameOver) { update(); frames++; requestAnimationFrame(loop); } else {
      bestScore = Math.max(bestScore, score);
      ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0, canvas.height/2 - 60, canvas.width, 160);
      ctx.fillStyle = '#fff'; ctx.font = '24px Arial'; ctx.textAlign='center';
      ctx.fillText('Game Over! Score: ' + score, canvas.width/2, canvas.height/2 - 10);
      ctx.fillText('Best: ' + bestScore, canvas.width/2, canvas.height/2 + 30);
      ctx.fillText('Tap / Click to restart', canvas.width/2, canvas.height/2 + 70);
    }
  }
  loop();
}

// Input handling: start bgm on first interaction and play flap sound
function handleInput(e) {
  e && e.preventDefault && e.preventDefault();
  ensureAudioStarted();
  // start playing bgm when first interaction
  if (bgm.paused) { bgm.currentTime = 0; bgm.play().catch(()=>{}); }
  if (!gameOver) { bird.flap(); playFlap(); } else { gameOver=false; score=0; speed=2; bird.reset(); pipes.reset(); startGame(); }
}

document.addEventListener('keydown', e => { if (e.code === 'Space') handleInput(); });
window.addEventListener('touchstart', handleInput, { passive: false });
window.addEventListener('mousedown', handleInput);

loadAssets();
</script>
</body>
</html>
